\documentclass[OPS,authoryear,toc]{lsstdoc}
% lsstdoc documentation: https://lsst-texmf.lsst.io/lsstdoc.html
\input{meta}

% Package imports go here.

% Local commands go here.

%If you want glossaries
%\input{aglossary.tex}
%\makeglossaries

\title{Compute Resource Usage of DP0.2 production run}

% Optional subtitle
% \setDocSubtitle{A subtitle}

\author{%
Brian Yanny, Nikolay Kuropatkin, Huan Lin, Jennifer Adelman-McCarthy, Colin Slater, Hsin-Fang Chiang
}

\setDocRef{RTN-039}
\setDocUpstreamLocation{\url{https://github.com/lsst/rtn-039}}

\date{\vcsDate}

% Optional: name of the document's curator
% \setDocCurator{The Curator of this Document}

\setDocAbstract{%
Summary of cpu-time, memory, storage of DP0.2 production run in iDF.
}

% Change history defined here.
% Order: oldest first.
% Fields: VERSION, DATE, DESCRIPTION, OWNER NAME.
% See LPM-51 for version number policy.
\setDocChangeRecord{%
  \addtohist{1}{YYYY-MM-DD}{Unreleased.}{Brian Yanny}
}


\begin{document}

% Create the title page.
\maketitle
% Frequently for a technote we do not want a title page  uncomment this to remove the title page and changelog.
% use \mkshorttitle to remove the extra pages

% ADD CONTENT HERE
% You can also use the \input command to include several content files.

\section{Introduction and Scope of DP0.2}

DP0.2 (Data Preview 0.2) consisted of the (re)processing of a 
set of approximately 20,000 Rubin camera simulated exposures (each with up to
189 detectors per exposure) covering 157 tracts 
(\sim 300 square degrees) in 6 filters ($ugrizy$) to a typical 
depth of half that of the full survey.  These 20K visits represent 
approximately 10 nights of data gathering, roughly 1% of the 
full survey.

Processing of the DESC-generated DC-2 simulated dataset \citep{DESC} took place between Dec 18, 2021 and May 16, 2022.  Processing took place in a Google Cloud environment, named the iDF (Interim Data Facility).  In excess of 4,000 cores
were available in a number of queues and memory/core configurations
within the cloud production environment.  The total cpu usage over the 
course of DP0.2 was approximately 2.5M core-hours. Storage was provided 
in the form of S3 addressable object storage space.  At peak, the production 
used 3.3 PiB of object store. After removal of intermediate data products
(Warp images and intermediate single epoch CCD images), the final storage
in the S3 data store at the end of DP0.2 production amounted to approximately
2.55 PiB. 

The scope of production consisted of running seven pipeline steps. Each step
was in turn made up of one or more pipetasks.   Before production
started, the 20K raw exposures/visits were pre-loaded into S3 storage, along
with dimension and URI metadata in a common butler registry, 
used for all processing.  

A Skymap and Photometric solutions for the 
raw exposures were also provided ahead of time -- these were not created
as part of the DP0.2 processing.

After processing was complete, a copy of the large butler registry was made
for end user access and HiPS (large-format zoomable, pannable) image maps 
of the tracts were generated. Also, the detected and measured output object 
and source tables were put into a qServ database for collaboration
access.  These Butler copy, HiPS creation and qServ loading operations
are not included in the compute resources tabulated here. 

\section{Software Configuration}

The versions of the LSST software environment used for production were
based on 'v23' of the lsst distribution.  After the start of step 1 processingA number of updates to
the software occured to address issues encountered during processing
and this resulted in the small revision numbers of the 'v23' distribution
to change during DP0.2.

The workflow software system was \cite{PanDA}, and the 
BPS (Batch Processing Service) software 
(part of the LSST distribution) was used interface between the Butler 
using a set of job submission files 
(one for each group of each step of processing, see below)
and the PanDA system. In addition, the Google Cloug logging system was
used to collect logging information output by the production pipelines and
organize it into a searchable form.

\section{Processing Groups and clustering directives}

Each step of the seven step processing flow for DP0.2 
(modeled on the eventual Data Release Production (DRP) system 
planned for regular daily and annual Rubin processing) consists of a well
defined, ordered list of pipeline tasks run on either a set of 
single or dual exposure visits (steps 1,2,4,6) or on 
coadd tracts (steps 3, 5, 7) (and their associated visits).  

The BPS system takes as input a yaml file. The yaml files used during DP0.2 are archived at: \url{https://github.com/lsst-dm/dp02-processing/tree/main/full/production}.  As step 1 production commenced it was determined that an arbitrarily
large number of quanta could not be successfully processed with a single
BPS submission.  For example, step 1 production runs five pipetasks on 
20K visits, where each visit consists of typically 150 detector images,
thus resulting in 20K*150*5 = 15M individual quanta of processing for
step 1.  

A key component of the PanDA workflow system is the "Intelligent Data Delivery Service" (IDDS) which manages the scheduling of individual processing
quanta to a set of processing cores. The BPS and step description yaml configurations guide the creation of a "quantum graph" which fully describes the job flow
dependencies (what tasks depend on what other tasks being complete).  Also
created at the same time as the quantum graph for each 'BPS submit', is a
so-called 'execution butler' which contains file metadata and 
URI information for all inputs needed to completely run a processing step.

While one can define a single large DP0.2 step 1 BPS configuration yaml file,
specifying all 20K visits to be processed, time and memory restrictions
on the Butler and PanDa prevented successful completion of the implied 
15M quanta processing in a single BPS submission.
One issue was time to generate the quantum graph and execution butler was
prohibitive, even after some speed ups to the process, it would still take
days and many hundreds of GB to generate such quantum graphs and execution
butlers.  Practically speaking, there is a limit of a few hours and a few GB
for preparation of the quantum graph and execution butler.  

A more serious limitation comes with the operation of the IDDS and how
quanta are clustered (or not clustered).  The IDDS system has within it an $N^2$algorithm which matches jobs done to jobs-to-be-done.


\begin{center}
\begin{tabular} { |c|r|r|c|c|r|l|l|}
\hline
step & group by & N groups & start & end & core-hr & software & Note\\
\hline
step1 & visit/det & 14x3 &2022-12-18& 2022-01-12 & 166K & $\rm v23\_0\_0\_rc5$ &\\
step2 & visit  & 14 & 2022-01-20& 2022-01-24 & 22K & $\rm v23\_0\_0\_rc5$ &\\
step3 & tract & 33 & 2022-02-18& 2022-03-25 & 1100K & $\rm v23\_0\_1$ &\\
step4 & visit & 40& 2022-04-01& 2022-04-30 & 1100K & $\rm v23\_0\_1\_rc4$ &\\
step7 & all & 1 & 2022-05-01& 2022-05-01 & 10 & $\rm v23\_0\_2\_rc2$ &\\
step5 & tract & 52 & 2022-05-03& 2022-05-12 & 66K & $\rm v23\_0\_2\_rc2$ &\\
step6 & visit & 20&2022-05-12& 2022-05-16 & 16K & $\rm v23\_0\_2\_rc3$ &\\
purge & exp/warp & 2 & 2022-04-01& 2022-05-30 & 10 & $\rm v23\_0\_2\_rc2$ & \\
\hline
total & & & 150d & & 2500K &&\\
\hline
\end{tabular}
\end{center}


\begin{center}
\begin{tabular} { |l|r|r|l|}
\hline
queue & maxMem(GB) & used by &  Note\\
\hline
$\rm DOMA\_LSST\_GOOGLE\_TEST$ & 14 & default &\\
$\rm DOMA\_LSST\_GOOGLE\_MERGE$ & 14 & butler merge &\\
$\rm DOMA\_LSST\_GOOGLE\_HIMEM$ & 40 &  &\\
$\rm DOMA\_LSST\_GOOGLE\_HIMEM\_NON\_PREEMPT$ & 40 & &\\
$\rm DOMA\_LSST\_GOOGLE\_EXTRA\_HIMEM$ & 236 &  &\\
$\rm DOMA\_LSST\_GOOGLE\_EXTRA\_HIMEM\_NON\_PREEMPT$ & 236 & &\\
\hline
\end{tabular}
\end{center}

\begin{center}
\begin{tabular} { |l|r|r|}
\hline
pipetask & reqMem(MB) &  Notes\\
\hline
  makeWarp&  8192&\\
  assembleCoadd&  16384&\\
  deblend&  16384&\\
  measure&  16384&\\
  mergeMeasurements&  16384&\\
  forcedPhotCoadd&  4096&\\
  writeObjectTable&  16384&\\
  matchCatalogsPatch&  4096&\\
  modelPhotRepGal4&  4096&\\
  imageDifference&  4096&\\
  matchCatalogsPatchMultiBand&  120000&\\
  matchCatalogsTract&  120000&\\
  wPerp&  120000&\\
  TE1&  46000&\\
  TE2&  46000&\\
  consolidateObjectTable&  4096&\\
  consolidateForcedSourceTable&  120000&\\
  consolidateForcedSourceOnDiaObjectTable&  18000&\\
\hline
 deblend& 32768& step 3 rescue\\
  measure& 16384 & 40 GB NO PE \\
\hline
deblend& 32768& step 3 faro rescue \\
deblend& 32768& 236GB NO PE\\
matchCatalogsPatchMultiBand& 120000& 236GB NO PE\\
matchCatalogsTract& 120000 & 236GB NO PE\\
\hline
consolidateForcedSourceOnDiaObjectTable& 18000& step 5 40 GB\\
\hline
\end{tabular}
\end{center}


\begin{center}
\begin{tabular} { |r|r|r|r|r|r|}
\hline
TB& Nobj & MB/obj & step & D & dataSetType \\
\hline
260 & 2.9M & 90 & input & & raw \\
\hline
506&5.1M&104&step3&D&deepCoadd$\_$directWarp\\
506&2.2M&230&step4&&	goodSeeingDiff$\_$templateExp\\
389&5.1M&80&step3&D&deepCoadd$\_$psfMatchedWarp\\
293&2.9M&102&step1&D&icExp\\
283&2.8M&101&step1&&	calexp\\
258&2.9M&90&step1&D&postISRCCD\\
224&2.2M&102&step4&&	goodSeeingDiff$\_$differenceExp\\
200&3.4M&60&step4&&	forced$\_$diff\\
184&4.6M&40&step5&&	forced$\_$diff$\_$diaObject\\
150&3.4M&44&step4&&	mergedForcedSource\\
39&0.6M&651&step3&&	deepCoadd$\_$meas\\
18&4.6M&4&step5	&&forced$\_$src$\_$diaObject\\
12&7.5K&1600&step5&&	forcedSourceTable\\
12&0.6M&196&step3&&	deepCoadd\\
12&0.6M&196&step3&&	deepCoadd$\_$calexp\\
10&2.6M&3.7&step6&&	calibratedSource\\
8.4&	2.8M&3&step1&&	source\\
8.3&	0.6M&141&step3&&	goodSeeingCoadd\\
5 &4.6M&1.2&step5&&	mergedForcedSourceOnDiaObject\\
3.4&3.4M&1.0&step4&&	forced$\_$src\\
3.4&2.8M&1.20&step1&&	sourceTable\\
\hline
\end{tabular}
\end{center}

\begin{center}
\begin{tabular} { |r|r|r|r|r|r|}
\hline
TB&Nobj&MB/Obj&step&D& DataSetType (continued)\\
\hline
2.4&2.8M&0.85&step1&&	icSrc\\
1.6&10K&170&step3&&	objectTable\\
1.3&2.6M&0.5&step6&&	calibratedSourceTable\\
1&20K&50&step6	&&calibratedSourceTable$\_$visit\\
1.2&20K&58&step2&&	sourceTable$\_$visit\\
1.0&156&6600&step3&&	objectTable$\_$tract\\
0.5&60K&6.4&step3&&	deepCoadd$\_$inputMap\\
0.4&2.2M&0.18&step4&&	goodSeeingDiff$\_$diaSrc\\
0.3&2.8M&0.11&step1&&	calexpBackground\\
0.28&7.5K&36&step5&&	forcedSourceOnDiaObjectTable\\
0.2&150&1900&step5&&	forcedSourceOnDiaObjectTable$\_$tract\\
0.2&2.9M&0.08&step1&&	icExpBackground\\
0.2&60K&4&step3	&&deepCoadd$\_$det\\
0.2&60K&3&step3	&&deepCoadd$\_$measMatchFull\\
0.12&2.2M&0.06&step4&&	goodSeeingDiff$\_$diaSrcTable\\
0.1&60K&2.4&step3&&	deepCoadd$\_$nImage\\
0.1&60K&1.4&step3&&	goodSeeingCoadd$\_$nImage\\
0.02&20K&1&step6&&	diaSourceTable\\
0.02&2.8M&0.01&step1&&	srcMatch (src:7MB)\\
0.02&20K&0.10&step2&&	visitSummary\\
0&	1&316&step7&&	ccdVisitTable\\
0&	1&2.4&step7&&	visitTable\\
\hline
0.4& 200 & 2000 & BPS &   & Ext Butler\\
0.22& 200 & 1100 & BPS &   & qgraph \\
\hline
3.4PB(1.9PB)& & & & & Total in S3 without(with) Deletes\\
\hline
\end{tabular}
\end{center}

D: DataSetType deleted from Butler and Storage


\appendix
% Include all the relevant bib files.
% https://lsst-texmf.lsst.io/lsstdoc.html#bibliographies
\section{References} \label{sec:bib}
\renewcommand{\refname}{} % Suppress default Bibliography section
\bibliography{local,lsst,lsst-dm,refs_ads,refs,books}

% Make sure lsst-texmf/bin/generateAcronyms.py is in your path
\section{Acronyms} \label{sec:acronyms}
\input{acronyms.tex}
% If you want glossary uncomment below -- comment out the two lines above
%\printglossaries


\end{document}
